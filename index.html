<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maki Web</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f7; margin: 0; }
    .login-container, .container { max-width: 600px; margin: auto; padding: 20px; }
    .login-box, .signup-container, .section {
      background: white; padding: 30px; border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-top: 20px; position: relative;
    }
    .login-box { text-align: center; }
    .close-btn {
      position: absolute; top: 10px; right: 15px; cursor: pointer;
      background: none; border: none; font-size: 20px;
    }
    input[type="text"], input[type="password"], input[type="number"], input[type="date"] {
      width: 100%; padding: 10px; margin: 10px 0;
      border-radius: 10px; border: 1px solid #ccc;
    }
    button {
      padding: 10px 15px; border: none; background: #555; color: white;
      border-radius: 10px; cursor: pointer;
    }
    button:hover { background: #333; }
    .nav-buttons {
      display: flex; flex-wrap: wrap; gap: 10px;
      justify-content: center; margin-bottom: 20px;
    }
    .nav-buttons button { flex: 1; min-width: 100px; }
    .dashboard, .page { display: none; }
    .active { display: block; }
    .item {
      display: flex; align-items: center; gap: 10px; margin: 10px 0;
    }
    .item input[type="number"], .item input[type="date"] { width: 100px; display: block; }
    .item button {
      background-color: red; border-radius: 50%; padding: 5px 10px;
      border: none; color: white; font-weight: bold; cursor: pointer;
    }
    footer {
      text-align: center; padding: 10px; background: #ddd;
      position: fixed; bottom: 0; width: 100%;
    }
    table {
      border-collapse: collapse; 
      width: 100%;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px; text-align: left;
    }

    /* Archive modal styles */
    #archiveModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    #archiveContent {
      background-color: #fff;
      margin: 50px auto;
      padding: 20px;
      border-radius: 15px;
      max-width: 600px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      position: relative;
    }
    #archiveContent h3 {
      margin-top: 0;
    }
    #archiveCloseBtn {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
    .archive-item {
      border-bottom: 1px solid #ccc;
      padding: 10px 0;
    }
    .archive-item:last-child {
      border-bottom: none;
    }
    .archive-timestamp {
      font-weight: bold;
      color: #333;
    }
    .archive-summary {
      margin-left: 10px;
      font-style: italic;
      color: #666;
    }

    /* Archive icon button styling */
    #archiveBtn {
      background: #1e90ff;
      border-radius: 10px;
      margin-left: 10px;
      padding: 8px 12px;
      font-size: 16px;
    }
    #archiveBtn:hover {
      background: #0d6efd;
    }
  </style>
</head>
<body>

<div class="login-container" id="loginPage" style="display: block;">
  <div class="login-box">
    <h1>Budget Tracker</h1>
    <input type="text" id="loginUsername" placeholder="Username" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button onclick="login()">Log In</button>
    <p id="loginError" style="color:red;"></p>
    <hr />
    <button onclick="document.getElementById('signupContainer').style.display = 'block';">Create Account</button>
  </div>
  <div id="signupContainer" class="signup-container" style="display:none;">
    <button class="close-btn" onclick="document.getElementById('signupContainer').style.display='none';">‚úñ</button>
    <h3>Sign Up</h3>
    <input type="text" id="newUsername" placeholder="New Username" />
    <input type="password" id="newPassword" placeholder="New Password" />
    <button onclick="addUser()">Sign Up</button>
  </div>
</div>

<div class="container dashboard" id="dashboard" style="display: none;">
  <div class="nav-buttons">
    <button onclick="showPage('settingsPage')">‚öôÔ∏è Settings</button>
    <button onclick="showPage('expensesPage')">üìÑ Expenses</button>
    <button onclick="showPage('groceryPage')">üõí Grocery</button>
    <button onclick="showPage('onlinePage')">üíª Online</button>
    <button onclick="showPage('marketPage')">üß∫ Market</button>
    <button onclick="logout()">üö™ Logout</button>
  </div>

  <div id="settingsPage" class="page section">
    <h2>Settings</h2>
    <input type="text" id="removeUsername" placeholder="Username to Remove" />
    <button onclick="removeUser()">Remove User</button>
  </div>

  <div id="expensesPage" class="page section">
    <h2>Expenses Report
      <button id="archiveBtn" title="View Archive" onclick="openArchive()">üì¶ Archive</button>
    </h2>
    <input type="number" id="incomeInput" placeholder="Set Income" />
    <button onclick="setIncome()">Update Income</button>
    <p>Income: ‚Ç±<span id="incomeDisplay">0.00</span></p>
    <p>Expenses: ‚Ç±<span id="expensesDisplay">0.00</span></p>
    <p>Balance: ‚Ç±<span id="expensesBalance">0.00</span></p>
    <label>Filter by Date:</label>
    <input type="date" id="filterDate" onchange="loadExpenses()" />
    <button onclick="exportPDF()">üìÑ Export as PDF</button>
    <table>
      <thead><tr><th>Date</th><th>Section</th><th>Description</th><th>Amount</th></tr></thead>
      <tbody id="expensesTable"></tbody>
    </table>
  </div>

  <div id="groceryPage" class="page section">
    <h2>Grocery Budget</h2>
    <input type="number" id="groceryBudgetInput" placeholder="Set Budget" />
    <button onclick="setBudget('grocery')">Set Budget</button>
    <p>Budget: ‚Ç±<span id="groceryBudget">0.00</span></p>
    <p>Balance: ‚Ç±<span id="groceryBalance">0.00</span></p>
    <input type="text" id="groceryNewItemName" placeholder="New Item Name" />
    <button onclick="addNewItem('grocery')">Add Item</button>
    <div id="groceryItemsList"></div>
  </div>

  <div id="onlinePage" class="page section">
    <h2>Online Budget</h2>
    <input type="number" id="onlineBudgetInput" placeholder="Set Budget" />
    <button onclick="setBudget('online')">Set Budget</button>
    <p>Budget: ‚Ç±<span id="onlineBudget">0.00</span></p>
    <p>Balance: ‚Ç±<span id="onlineBalance">0.00</span></p>
    <input type="text" id="onlineNewItemName" placeholder="New Item Name" />
    <button onclick="addNewItem('online')">Add Item</button>
    <div id="onlineItemsList"></div>
  </div>

  <div id="marketPage" class="page section">
    <h2>Market Budget</h2>
    <input type="number" id="marketBudgetInput" placeholder="Set Budget" />
    <button onclick="setBudget('market')">Set Budget</button>
    <p>Budget: ‚Ç±<span id="marketBudget">0.00</span></p>
    <p>Balance: ‚Ç±<span id="marketBalance">0.00</span></p>
    <input type="text" id="marketNewItemName" placeholder="New Item Name" />
    <button onclick="addNewItem('market')">Add Item</button>
    <div id="marketItemsList"></div>
  </div>
</div>

<footer>
  &copy; 2025 Maki Web. All rights reserved
</footer>

<!-- Archive Modal -->
<div id="archiveModal">
  <div id="archiveContent">
    <button id="archiveCloseBtn" title="Close Archive">‚úñ</button>
    <h3>Archived Data</h3>
    <div id="archiveList"></div>
  </div>
</div>

<script>
  // Helper functions
  function getUsers() {
    return JSON.parse(localStorage.getItem("users") || "[]");
  }
  function saveUsers(users) {
    localStorage.setItem("users", JSON.stringify(users));
  }
  function getCurrentUser() {
    return localStorage.getItem("currentUser");
  }
  function setCurrentUser(username) {
    localStorage.setItem("currentUser", username);
  }
  function getUserData(username) {
    return JSON.parse(localStorage.getItem(username) || '{"income":0,"budgets":{"grocery":0,"online":0,"market":0},"items":{"grocery":[],"online":[],"market":[]}}');
  }
  function saveUserData(username, data) {
    localStorage.setItem(username, JSON.stringify(data));
  }
  function getArchive() {
    return JSON.parse(localStorage.getItem("archive") || "[]");
  }
  function saveArchive(archive) {
    localStorage.setItem("archive", JSON.stringify(archive));
  }

  // Login
  function login() {
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    const users = getUsers();
    const user = users.find(u => u.username === username && u.password === password);
    const errorEl = document.getElementById("loginError");
    if (!username || !password) {
      errorEl.textContent = "Enter username and password.";
      return;
    }
    if (user) {
      setCurrentUser(username);
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      errorEl.textContent = "";
      loadUserData();
      showPage("expensesPage");
    } else {
      errorEl.textContent = "Invalid username or password.";
    }
  }

  // Sign up
  function addUser() {
    const newUsername = document.getElementById("newUsername").value.trim();
    const newPassword = document.getElementById("newPassword").value.trim();
    if (!newUsername || !newPassword) {
      alert("Please enter username and password.");
      return;
    }
    const users = getUsers();
    if (users.find(u => u.username === newUsername)) {
      alert("Username already exists.");
      return;
    }
    users.push({ username: newUsername, password: newPassword });
    saveUsers(users);
    // Initialize user data
    saveUserData(newUsername, { income: 0, budgets: { grocery: 0, online: 0, market: 0 }, items: { grocery: [], online: [], market: [] } });
    alert("User created successfully! Please login.");
    document.getElementById("signupContainer").style.display = "none";
  }

  // Logout
  function logout() {
    localStorage.removeItem("currentUser");
    location.reload();
  }

  // Remove user
  function removeUser() {
    const removeUsername = document.getElementById("removeUsername").value.trim();
    if (!removeUsername) {
      alert("Please enter a username to remove.");
      return;
    }
    let users = getUsers();
    if (!users.find(u => u.username === removeUsername)) {
      alert("User not found.");
      return;
    }
    users = users.filter(u => u.username !== removeUsername);
    saveUsers(users);
    localStorage.removeItem(removeUsername);
    alert(`User ${removeUsername} removed.`);
    document.getElementById("removeUsername").value = "";
  }

  // Show page
  function showPage(pageId) {
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    document.getElementById(pageId).style.display = "block";
    if (pageId === "expensesPage") {
      loadExpenses();
      updateIncomeExpensesBalance();
    }
  }

  // Load user data into UI
  function loadUserData() {
    const user = getCurrentUser();
    if (!user) return;
    const data = getUserData(user);

    document.getElementById("incomeDisplay").textContent = Number(data.income).toFixed(2);
    document.getElementById("incomeInput").value = data.income || 0;

    ["grocery","online","market"].forEach(section => {
      document.getElementById(section + "Budget").textContent = Number(data.budgets[section]).toFixed(2);
      document.getElementById(section + "BudgetInput").value = data.budgets[section] || 0;
      renderItems(section);
    });

    updateIncomeExpensesBalance();
  }

  // Set income
  function setIncome() {
    const user = getCurrentUser();
    if (!user) return;
    const incomeInput = document.getElementById("incomeInput");
    const newIncome = parseFloat(incomeInput.value);
    if (isNaN(newIncome) || newIncome < 0) {
      alert("Please enter a valid positive number for income.");
      return;
    }
    // Archive current data before resetting income
    archiveCurrentUserData();

    // Reset user data with new income and empty budgets/items
    saveUserData(user, {
      income: newIncome,
      budgets: { grocery: 0, online: 0, market: 0 },
      items: { grocery: [], online: [], market: [] }
    });
    loadUserData();
  }

  // Archive current user data
  function archiveCurrentUserData() {
    const user = getCurrentUser();
    if (!user) return;
    const data = getUserData(user);
    if (!data) return;
    // Avoid archiving empty income data
    if (!data.income || data.income === 0) return;

    let archive = getArchive();
    archive.push({
      username: user,
      timestamp: new Date().toISOString(),
      data: JSON.parse(JSON.stringify(data)) // deep copy
    });
    saveArchive(archive);
  }

  // Set budget
  function setBudget(section) {
    const user = getCurrentUser();
    if (!user) return;
    const budgetInput = document.getElementById(section + "BudgetInput");
    let newBudget = parseFloat(budgetInput.value);
    if (isNaN(newBudget) || newBudget < 0) {
      alert("Please enter a valid positive number for budget.");
      return;
    }
    const data = getUserData(user);

    // Check total budgets to not exceed income
    let totalOtherBudgets = 0;
    for (let key in data.budgets) {
      if (key !== section) totalOtherBudgets += data.budgets[key];
    }
    if (totalOtherBudgets + newBudget > data.income) {
      alert("Total budgets cannot exceed income.");
      return;
    }

    data.budgets[section] = newBudget;
    saveUserData(user, data);
    loadUserData();
  }

  // Add new item
  function addNewItem(section) {
    const user = getCurrentUser();
    if (!user) return;
    const newItemNameInput = document.getElementById(section + "NewItemName");
    const itemName = newItemNameInput.value.trim();
    if (!itemName) {
      alert("Please enter an item name.");
      return;
    }
    const data = getUserData(user);

    // Check if item already exists
    if (data.items[section].find(i => i.name.toLowerCase() === itemName.toLowerCase())) {
      alert("Item already exists in this section.");
      return;
    }

    data.items[section].push({ name: itemName, amount: 0, date: new Date().toISOString().slice(0,10) });
    saveUserData(user, data);
    newItemNameInput.value = "";
    renderItems(section);
  }

  // Render items for section
  function renderItems(section) {
    const user = getCurrentUser();
    if (!user) return;
    const data = getUserData(user);
    const container = document.getElementById(section + "ItemsList");
    container.innerHTML = "";

    if (!data.items[section].length) {
      container.innerHTML = "<p>No items added.</p>";
      updateBalance(section);
      return;
    }

    data.items[section].forEach((item, index) => {
      const div = document.createElement("div");
      div.className = "item";

      const nameSpan = document.createElement("span");
      nameSpan.style.flex = "2";
      nameSpan.textContent = item.name;

      const amountInput = document.createElement("input");
      amountInput.type = "number";
      amountInput.min = "0";
      amountInput.value = item.amount;
      amountInput.style.flex = "1";
      amountInput.onchange = () => {
        const val = parseFloat(amountInput.value);
        if (isNaN(val) || val < 0) {
          amountInput.value = item.amount;
          alert("Enter a valid positive number.");
          return;
        }
        data.items[section][index].amount = val;
        saveUserData(user, data);
        updateBalance(section);
        updateIncomeExpensesBalance();
      };

      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.value = item.date;
      dateInput.style.flex = "1.5";
      dateInput.onchange = () => {
        data.items[section][index].date = dateInput.value;
        saveUserData(user, data);
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "x";
      deleteBtn.title = "Delete Item";
      deleteBtn.onclick = () => {
        if (!confirm(`Delete item "${item.name}"?`)) return;
        data.items[section].splice(index, 1);
        saveUserData(user, data);
        renderItems(section);
        updateBalance(section);
        updateIncomeExpensesBalance();
      };

      div.appendChild(nameSpan);
      div.appendChild(amountInput);
      div.appendChild(dateInput);
      div.appendChild(deleteBtn);
      container.appendChild(div);
    });

    updateBalance(section);
  }

  // Update balance for a section
  function updateBalance(section) {
    const user = getCurrentUser();
    if (!user) return;
    const data = getUserData(user);
    const budget = data.budgets[section];
    const totalExpenses = data.items[section].reduce((a,v) => a + (parseFloat(v.amount) || 0), 0);
    const balance = budget - totalExpenses;
    document.getElementById(section + "Balance").textContent = balance.toFixed(2);
  }

  // Load expenses report
  function loadExpenses() {
    const user = getCurrentUser();
    if (!user) return;
    const data = getUserData(user);
    const expensesTable = document.getElementById("expensesTable");
    expensesTable.innerHTML = "";

    const filterDate = document.getElementById("filterDate").value;

    let allItems = [];
    ["grocery", "online", "market"].forEach(section => {
      data.items[section].forEach(item => {
        allItems.push({ ...item, section });
      });
    });

    if (filterDate) {
      allItems = allItems.filter(i => i.date === filterDate);
    }

    if (allItems.length === 0) {
      expensesTable.innerHTML = '<tr><td colspan="4" style="text-align:center;">No expenses found for this date.</td></tr>';
      return;
    }

    allItems.sort((a,b) => a.date.localeCompare(b.date));

    allItems.forEach(item => {
      const tr = document.createElement("tr");
      const tdDate = document.createElement("td");
      tdDate.textContent = item.date;
      const tdSection = document.createElement("td");
      tdSection.textContent = item.section;
      const tdName = document.createElement("td");
      tdName.textContent = item.name;
      const tdAmount = document.createElement("td");
      tdAmount.textContent = Number(item.amount).toFixed(2);
      tr.appendChild(tdDate);
      tr.appendChild(tdSection);
      tr.appendChild(tdName);
      tr.appendChild(tdAmount);
      expensesTable.appendChild(tr);
    });
  }

  // Update income/expenses/balance display
  function updateIncomeExpensesBalance() {
    const user = getCurrentUser();
    if (!user) return;
    const data = getUserData(user);

    const totalExpenses = ["grocery", "online", "market"].reduce((total, section) => {
      return total + data.items[section].reduce((a,v) => a + (parseFloat(v.amount) || 0), 0);
    }, 0);

    document.getElementById("expensesDisplay").textContent = totalExpenses.toFixed(2);
    const balance = data.income - totalExpenses;
    document.getElementById("expensesBalance").textContent = balance.toFixed(2);
  }

  // Export expenses report to PDF
  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const user = getCurrentUser();
    if (!user) return;
    const data = getUserData(user);

    doc.setFontSize(18);
    doc.text(`Expenses Report for ${user}`, 14, 22);
    doc.setFontSize(12);
    doc.text(`Income: ‚Ç±${data.income.toFixed(2)}`, 14, 30);
    let totalExpenses = 0;

    let rows = [];
    ["grocery", "online", "market"].forEach(section => {
      data.items[section].forEach(item => {
        rows.push([item.date, section, item.name, "‚Ç±" + Number(item.amount).toFixed(2)]);
        totalExpenses += parseFloat(item.amount) || 0;
      });
    });
    doc.text(`Total Expenses: ‚Ç±${totalExpenses.toFixed(2)}`, 14, 38);

    doc.autoTable({
      head: [['Date', 'Section', 'Description', 'Amount']],
      body: rows,
      startY: 45,
      margin: { horizontal: 14 },
      styles: { fontSize: 10 }
    });

    doc.save(`Expenses_${user}_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  // Archive modal functions
  function openArchive() {
    const archiveModal = document.getElementById("archiveModal");
    const archiveList = document.getElementById("archiveList");
    archiveList.innerHTML = "";

    let archive = getArchive();
    const currentUser = getCurrentUser();

    if (!archive.length) {
      archiveList.innerHTML = "<p>No archived data found.</p>";
    } else {
      // Show only archives for current user, newest first
      const userArchives = archive.filter(a => a.username === currentUser).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
      if (!userArchives.length) {
        archiveList.innerHTML = "<p>No archived data for current user.</p>";
      } else {
        userArchives.forEach(entry => {
          const div = document.createElement("div");
          div.className = "archive-item";

          const date = new Date(entry.timestamp);
          const timestampStr = date.toLocaleString();

          // Calculate total expenses in archived data
          const totalArchivedExpenses = ["grocery", "online", "market"].reduce((total, section) => {
            return total + entry.data.items[section].reduce((a,v) => a + (parseFloat(v.amount) || 0), 0);
          }, 0);

          const incomeStr = `Income: ‚Ç±${Number(entry.data.income).toFixed(2)}`;
          const expensesStr = `Expenses: ‚Ç±${totalArchivedExpenses.toFixed(2)}`;
          const balanceStr = `Balance: ‚Ç±${(entry.data.income - totalArchivedExpenses).toFixed(2)}`;

          div.innerHTML = `
            <span class="archive-timestamp">${timestampStr}</span>
            <span class="archive-summary">${incomeStr} | ${expensesStr} | ${balanceStr}</span>
          `;
          archiveList.appendChild(div);
        });
      }
    }

    archiveModal.style.display = "block";
  }
  document.getElementById("archiveCloseBtn").onclick = function() {
    document.getElementById("archiveModal").style.display = "none";
  };
  window.onclick = function(event) {
    const archiveModal = document.getElementById("archiveModal");
    if (event.target === archiveModal) {
      archiveModal.style.display = "none";
    }
  };

  // On window load, check login state and load data
  window.onload = function() {
    const user = getCurrentUser();
    if (user) {
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      loadUserData();
      showPage("expensesPage");
    } else {
      document.getElementById("loginPage").style.display = "block";
      document.getElementById("dashboard").style.display = "none";
    }
  };
</script>

</body>
</html>
