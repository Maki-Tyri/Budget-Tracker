<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Budget Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .section { margin-bottom: 40px; }
    .line-through { text-decoration: line-through; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>Budget Tracker</h1>
  <script>
    localStorage.setItem("currentUser", "demoUser");
  </script>

  <!-- Budget Section Template -->
  <div id="sections"></div>

  <!-- Expenses Report -->
  <div class="section">
    <h2>Expenses Report</h2>
    <table>
      <thead>
        <tr>
          <th>Section</th>
          <th>Item</th>
          <th>Price</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody id="expensesReportBody"></tbody>
    </table>
  </div>

  <script>
    let currentUser = localStorage.getItem("currentUser");
    const categories = ["grocery", "market", "online"];

    function initApp() {
      const container = document.getElementById("sections");
      categories.forEach(section => {
        container.innerHTML += `
          <div class="section">
            <h2>${section.charAt(0).toUpperCase() + section.slice(1)}</h2>
            <div>
              Budget: ₱<span id="${section}Budget">0</span>
              <input type="number" id="${section}BudgetInput" placeholder="Set budget">
              <button onclick="setBudget('${section}')">Set Budget</button>
            </div>
            <div>
              <input type="text" id="${section}ItemName" placeholder="Add item">
              <button onclick="addItem('${section}')">Add</button>
            </div>
            <ul id="${section}Items"></ul>
            <p>Total Spent: ₱<span id="${section}Total">0.00</span></p>
          </div>
        `;
      });

      loadBudgets();
      categories.forEach(loadItems);
      loadExpenses();

      setInterval(loadExpenses, 5000); // optional auto-refresh
    }

    function loadBudgets() {
      categories.forEach(section => {
        const budget = localStorage.getItem(`${currentUser}_${section}Budget`) || 0;
        document.getElementById(`${section}Budget`).textContent = budget;
      });
    }

    function setBudget(section) {
      const value = document.getElementById(`${section}BudgetInput`).value;
      localStorage.setItem(`${currentUser}_${section}Budget`, value);
      document.getElementById(`${section}Budget`).textContent = value;
      updateSummary(section);
      loadExpenses();
    }

    function addItem(section) {
      const input = document.getElementById(`${section}ItemName`);
      const name = input.value.trim();
      if (!name) return;
      const key = `${currentUser}_${section}Items`;
      const items = JSON.parse(localStorage.getItem(key) || '[]');
      items.push({ name, price: 0, checked: false });
      localStorage.setItem(key, JSON.stringify(items));
      input.value = '';
      loadItems(section);
      loadExpenses();
    }

    function deleteItem(section, index) {
      const key = `${currentUser}_${section}Items`;
      const items = JSON.parse(localStorage.getItem(key) || '[]');
      if (items[index]) {
        items[index].deleted = true;
        localStorage.setItem(key, JSON.stringify(items));
      }
      loadItems(section);
      loadExpenses();
    }

    function toggleItem(section, index, checked) {
      const key = `${currentUser}_${section}Items`;
      const items = JSON.parse(localStorage.getItem(key) || '[]');
      items[index].checked = checked;
      localStorage.setItem(key, JSON.stringify(items));
      loadItems(section);
      loadExpenses();
    }

    function updatePrice(section, index, value) {
      const key = `${currentUser}_${section}Items`;
      const items = JSON.parse(localStorage.getItem(key) || '[]');
      items[index].price = parseFloat(value) || 0;
      if (!items[index].date) {
        items[index].date = new Date().toISOString().split('T')[0];
      }
      localStorage.setItem(key, JSON.stringify(items));
      updateSummary(section);
      loadExpenses();
    }

    function loadItems(section) {
      const key = `${currentUser}_${section}Items`;
      const items = JSON.parse(localStorage.getItem(key) || '[]');
      const list = document.getElementById(`${section}Items`);
      list.innerHTML = '';
      items.forEach((item, index) => {
        if (item.deleted) return;
        const li = document.createElement('li');
        li.innerHTML = `
          <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleItem('${section}', ${index}, this.checked)">
          <span class="${item.checked ? 'line-through' : ''}">${item.name}</span>
          <input type="number" value="${item.price}" onchange="updatePrice('${section}', ${index}, this.value)">
          <button onclick="deleteItem('${section}', ${index})">Delete</button>
        `;
        list.appendChild(li);
      });
      updateSummary(section);
    }

    function updateSummary(section) {
      const key = `${currentUser}_${section}Items`;
      const items = JSON.parse(localStorage.getItem(key) || '[]');
      const total = items.reduce((sum, item) => {
        if (!item.deleted && item.checked) {
          return sum + (parseFloat(item.price) || 0);
        }
        return sum;
      }, 0);
      document.getElementById(`${section}Total`).textContent = total.toFixed(2);
    }

    function loadExpenses() {
      let allExpenses = [];
      categories.forEach(section => {
        const key = `${currentUser}_${section}Items`;
        const items = JSON.parse(localStorage.getItem(key) || '[]');
        items.forEach(item => {
          const price = parseFloat(item.price) || 0;
          const date = item.date || 'Unknown';
          const name = item.name || 'Unnamed';
          if (!isNaN(price) && price > 0) {
            allExpenses.push({ section, name, price, date });
          }
        });
      });

      allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

      const reportBody = document.getElementById('expensesReportBody');
      reportBody.innerHTML = '';
      allExpenses.forEach(exp => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${exp.section}</td>
          <td>${exp.name}</td>
          <td>${exp.price.toFixed(2)}</td>
          <td>${exp.date}</td>
        `;
        reportBody.appendChild(row);
      });
    }

    window.onload = initApp;
  </script>
</body>
</html>
