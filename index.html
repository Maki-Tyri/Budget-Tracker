<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maki Web</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #eef2f7;
      margin: 0;
    }
    .login-container, .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    .login-box, .signup-container, .section {
      background: white;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-top: 20px;
      position: relative;
    }
    .login-box {
      text-align: center;
    }
    .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 20px;
    }
    input[type="text"], input[type="password"], input[type="number"], input[type="date"] {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 15px;
      border: none;
      background: #555555; /* Gray */
      color: white;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover {
      background: #333333; /* Darker gray on hover */
    }
    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .nav-buttons button {
      flex: 1;
    }
    .dashboard, .page {
      display: none;
    }
    .active {
      display: block;
    }
    .item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .item input[type="number"] {
      width: 100px;
      display: block; /* Show input always for amount editing */
    }
    .item button {
      background-color: red;
      border-radius: 50%;
      padding: 5px 10px;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    footer {
      text-align: center;
      padding: 10px;
      background: #ddd;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
  </style>
</head>
<body>

<!-- Login Page -->
<div class="login-container" id="loginPage" style="display: block;">
  <div class="login-box">
    <h1>Maki Web</h1>
    <input type="text" id="loginUsername" placeholder="Username" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button onclick="login()">Log In</button>
    <p id="loginError" style="color:red;"></p>
    <hr />
    <button onclick="document.getElementById('signupContainer').style.display = 'block';">Create Account</button>
  </div>
  <div id="signupContainer" class="signup-container" style="display:none; position: relative;">
    <button class="close-btn" onclick="document.getElementById('signupContainer').style.display='none';">‚úñ</button>
    <h3>Sign Up</h3>
    <input type="text" id="newUsername" placeholder="New Username" />
    <input type="password" id="newPassword" placeholder="New Password" />
    <button onclick="addUser()">Sign Up</button>
  </div>
</div>

<!-- Dashboard -->
<div class="container dashboard" id="dashboard" style="display: none;">
  <div class="nav-buttons">
    <button onclick="showPage('settingsPage')">‚öôÔ∏è Settings</button>
    <button onclick="showPage('expensesPage')">üìÑ Expenses</button>
    <button onclick="showPage('groceryPage')">üõí Grocery</button>
    <button onclick="showPage('onlinePage')">üíª Online</button>
    <button onclick="showPage('marketPage')">üß∫ Market</button>
    <button onclick="logout()">üö™ Logout</button>
  </div>

  <!-- Settings Page -->
  <div id="settingsPage" class="page section">
    <h2>Settings</h2>
    <input type="text" id="removeUsername" placeholder="Username to Remove" />
    <button onclick="removeUser()">Remove User</button>
  </div>

  <!-- Expenses Page -->
  <div id="expensesPage" class="page section">
    <h2>Expenses Report</h2>
    <input type="number" id="incomeInput" placeholder="Set Income" />
    <button onclick="setIncome()">Update Income</button>
    <p>Income: ‚Ç±<span id="incomeDisplay">0.00</span></p>
    <p>Expenses: ‚Ç±<span id="expensesDisplay">0.00</span></p>
    <p>Balance: ‚Ç±<span id="expensesBalance">0.00</span></p>
    <label>Filter by Date:</label>
    <input type="date" id="filterDate" onchange="loadExpenses()" />
    <button onclick="exportPDF()">üìÑ Export as PDF</button>
    <table border="1" style="width:100%; margin-top:10px;">
      <thead><tr><th>Date</th><th>Section</th><th>Description</th><th>Amount</th></tr></thead>
      <tbody id="expensesTable"></tbody>
    </table>
  </div>

  <!-- Grocery Page -->
  <div id="groceryPage" class="page section">
    <h2>Grocery Budget</h2>
    <input type="number" id="groceryBudgetInput" placeholder="Set Budget" />
    <button onclick="setBudget('grocery')">Set Budget</button>
    <p>Budget: ‚Ç±<span id="groceryBudget">0.00</span></p>
    <p>Balance: ‚Ç±<span id="groceryBalance">0.00</span></p>
    <input type="text" id="groceryNewItemName" placeholder="New Item Name" />
    <button onclick="addNewItem('grocery')">Add Item</button>
    <div id="groceryItemsList"></div>
  </div>

  <!-- Online Page -->
  <div id="onlinePage" class="page section">
    <h2>Online Budget</h2>
    <input type="number" id="onlineBudgetInput" placeholder="Set Budget" />
    <button onclick="setBudget('online')">Set Budget</button>
    <p>Budget: ‚Ç±<span id="onlineBudget">0.00</span></p>
    <p>Balance: ‚Ç±<span id="onlineBalance">0.00</span></p>
    <input type="text" id="onlineNewItemName" placeholder="New Item Name" />
    <button onclick="addNewItem('online')">Add Item</button>
    <div id="onlineItemsList"></div>
  </div>

  <!-- Market Page -->
  <div id="marketPage" class="page section">
    <h2>Market Budget</h2>
    <input type="number" id="marketBudgetInput" placeholder="Set Budget" />
    <button onclick="setBudget('market')">Set Budget</button>
    <p>Budget: ‚Ç±<span id="marketBudget">0.00</span></p>
    <p>Balance: ‚Ç±<span id="marketBalance">0.00</span></p>
    <input type="text" id="marketNewItemName" placeholder="New Item Name" />
    <button onclick="addNewItem('market')">Add Item</button>
    <div id="marketItemsList"></div>
  </div>
</div>

<footer>¬© 2025 Budget Tracker</footer>

<script>
  // Load users list or default admin user
  let users = JSON.parse(localStorage.getItem('makiUsers')) || [{username: 'admin', password: '1234'}];

  // Store current user
  let currentUser = localStorage.getItem('makiCurrentUser') || null;

  // User data structures
  let income = 0;
  let budgets = { grocery: 0, online: 0, market: 0 };
  let items = { grocery: [], online: [], market: [] };
  let expenses = [];

  // Login function
  function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;

    if (!username || !password) {
      document.getElementById('loginError').textContent = "Enter username and password";
      return;
    }

    const user = users.find(u => u.username === username && u.password === password);
    if (user) {
      currentUser = username;
      localStorage.setItem('makiCurrentUser', currentUser);
      loadUserData();
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      showPage('expensesPage');
    } else {
      document.getElementById('loginError').textContent = "Invalid username or password";
    }
  }

  // Logout function
  function logout() {
    currentUser = null;
    localStorage.removeItem('makiCurrentUser');
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginPage').style.display = 'block';
    clearInputsAndErrors();
  }

  // Clear all inputs and errors on logout/login page
  function clearInputsAndErrors() {
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').textContent = '';
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('removeUsername').value = '';
  }

  // Add new user
  function addUser() {
    const newUsername = document.getElementById('newUsername').value.trim();
    const newPassword = document.getElementById('newPassword').value;

    if (!newUsername || !newPassword) {
      alert('Enter username and password');
      return;
    }

    if (users.find(u => u.username === newUsername)) {
      alert('Username already exists');
      return;
    }

    users.push({username: newUsername, password: newPassword});
    localStorage.setItem('makiUsers', JSON.stringify(users));
    alert('User created successfully');
    document.getElementById('signupContainer').style.display = 'none';
  }

  // Remove user
  function removeUser() {
    const usernameToRemove = document.getElementById('removeUsername').value.trim();
    if (!usernameToRemove) {
      alert('Enter username to remove');
      return;
    }
    if (!users.find(u => u.username === usernameToRemove)) {
      alert('User does not exist');
      return;
    }
    if (usernameToRemove === currentUser) {
      alert('You cannot remove the currently logged in user');
      return;
    }
    users = users.filter(u => u.username !== usernameToRemove);
    localStorage.setItem('makiUsers', JSON.stringify(users));
    alert('User removed');
    document.getElementById('removeUsername').value = '';
  }

  // Show dashboard page
  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    document.getElementById(pageId).style.display = 'block';
  }

  // Load user data or initialize defaults
  function loadUserData() {
    if (!currentUser) return;
    const data = JSON.parse(localStorage.getItem(`makiUserData_${currentUser}`));
    if (data) {
      income = data.income || 0;
      budgets = data.budgets || { grocery: 0, online: 0, market: 0 };
      items = data.items || { grocery: [], online: [], market: [] };
      expenses = data.expenses || [];
    } else {
      income = 0;
      budgets = { grocery: 0, online: 0, market: 0 };
      items = { grocery: [], online: [], market: [] };
      expenses = [];
    }
    calculateBalances();
    updateDashboardUI();
    loadItems('grocery');
    loadItems('online');
    loadItems('market');
    loadExpenses();
  }

  // Save user data to localStorage
  function saveUserData() {
    if (!currentUser) return;
    localStorage.setItem(`makiUserData_${currentUser}`, JSON.stringify({
      income,
      budgets,
      items,
      expenses
    }));
  }

  // Helper: Archive current user data before reset
  function archiveUserData() {
    if (!currentUser) return;
    const data = JSON.parse(localStorage.getItem(`makiUserData_${currentUser}`));
    if (!data) return;

    const timestamp = new Date().toISOString();
    const archiveKey = `makiUserData_${currentUser}_archive_${timestamp}`;
    localStorage.setItem(archiveKey, JSON.stringify(data));
  }

  // Set Income with validation and reset
  function setIncome() {
    let val = parseFloat(document.getElementById('incomeInput').value);
    if (isNaN(val) || val < 0) {
      alert('Enter a valid income amount');
      return;
    }

    // Check if existing total budgets exceed new income
    const totalBudgets = budgets.grocery + budgets.online + budgets.market;
    if (totalBudgets > val) {
      alert(`Cannot set income to ‚Ç±${val.toFixed(2)} because current budgets (‚Ç±${totalBudgets.toFixed(2)}) exceed it. Please adjust budgets first.`);
      return;
    }

    if (val !== income) {
      // Archive current data before resetting
      archiveUserData();

      // Reset all data
      income = val;
      budgets = {grocery:0, online:0, market:0};
      items = {grocery: [], online: [], market: []};
      expenses = [];
      calculateBalances();
      updateDashboardUI();
      saveUserData();

      // Clear all items UI lists
      loadItems('grocery');
      loadItems('online');
      loadItems('market');
      loadExpenses();
    }

    document.getElementById('incomeInput').value = '';
  }

  // Set Budget for a section with validation against income
  function setBudget(section) {
    const inputId = `${section}BudgetInput`;
    let val = parseFloat(document.getElementById(inputId).value);
    if (isNaN(val) || val < 0) {
      alert('Enter a valid budget amount');
      return;
    }

    const otherSections = ['grocery', 'online', 'market'].filter(s => s !== section);
    const otherBudgetsSum = otherSections.reduce((sum, s) => sum + budgets[s], 0);
    if ((otherBudgetsSum + val) > income) {
      alert(`Total budgets cannot exceed income (‚Ç±${income.toFixed(2)}). Please lower this budget.`);
      return;
    }

    budgets[section] = val;
    calculateBalances();
    updateDashboardUI();
    saveUserData();

    document.getElementById(inputId).value = '';
  }

  // Calculate balances for budgets and overall expenses
  function calculateBalances() {
    // Calculate total expenses
    let totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);

    // Calculate balance for each section
    ['grocery', 'online', 'market'].forEach(section => {
      let sectionExpenses = expenses
        .filter(e => e.section === section)
        .reduce((sum, e) => sum + e.amount, 0);
      budgets[`${section}Balance`] = budgets[section] - sectionExpenses;
    });

    // Store for UI display convenience
    expenses.totalExpenses = totalExpenses;
    expenses.balance = income - totalExpenses;
  }

  // Update dashboard UI elements to show current values
  function updateDashboardUI() {
    // Income and expenses on expenses page
    document.getElementById('incomeDisplay').textContent = income.toFixed(2);
    document.getElementById('expensesDisplay').textContent = expenses.totalExpenses ? expenses.totalExpenses.toFixed(2) : '0.00';
    document.getElementById('expensesBalance').textContent = expenses.balance ? expenses.balance.toFixed(2) : income.toFixed(2);

    // Budgets and balances for each section
    ['grocery', 'online', 'market'].forEach(section => {
      document.getElementById(`${section}Budget`).textContent = budgets[section].toFixed(2);
      // Calculate balance for this section again (for display)
      let sectionExpenses = expenses.filter(e => e.section === section).reduce((sum, e) => sum + e.amount, 0);
      let bal = budgets[section] - sectionExpenses;
      document.getElementById(`${section}Balance`).textContent = bal.toFixed(2);
    });
  }

  // Load items for a section (show list)
  function loadItems(section) {
    const container = document.getElementById(`${section}ItemsList`);
    container.innerHTML = '';

    items[section].forEach((item, idx) => {
      const div = document.createElement('div');
      div.className = 'item';

      const label = document.createElement('label');
      label.textContent = item.name;

      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.value = item.amount;
      input.onchange = () => {
        if (input.value === '' || parseFloat(input.value) < 0) {
          alert('Enter a valid amount');
          input.value = item.amount;
          return;
        }
        updateItemAmount(section, idx, parseFloat(input.value));
      };

      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'X';
      removeBtn.onclick = () => {
        removeItem(section, idx);
      };

      div.appendChild(label);
      div.appendChild(input);
      div.appendChild(removeBtn);
      container.appendChild(div);
    });
  }

  // Add new item for a section
  function addNewItem(section) {
    const inputId = `${section}NewItemName`;
    const name = document.getElementById(inputId).value.trim();
    if (!name) {
      alert('Enter a valid item name');
      return;
    }
    items[section].push({ name, amount: 0 });
    document.getElementById(inputId).value = '';
    loadItems(section);
    saveUserData();
  }

  // Update item amount and recalc expenses
  function updateItemAmount(section, index, amount) {
    items[section][index].amount = amount;
    recalcExpenses();
  }

  // Remove item from section
  function removeItem(section, index) {
    if (confirm('Remove this item?')) {
      items[section].splice(index, 1);
      recalcExpenses();
      loadItems(section);
    }
  }

  // Recalculate expenses array from items
  function recalcExpenses() {
    expenses = [];
    ['grocery', 'online', 'market'].forEach(section => {
      items[section].forEach(item => {
        if (item.amount > 0) {
          expenses.push({
            section,
            description: item.name,
            amount: item.amount,
            date: new Date().toISOString().slice(0, 10) // today as default
          });
        }
      });
    });
    calculateBalances();
    updateDashboardUI();
    saveUserData();
    loadExpenses();
  }

  // Load and display expenses in the table with optional date filter
  function loadExpenses() {
    const tableBody = document.getElementById('expensesTable');
    tableBody.innerHTML = '';
    const filterDate = document.getElementById('filterDate').value;

    let filtered = expenses;
    if (filterDate) {
      filtered = expenses.filter(e => e.date === filterDate);
    }

    filtered.forEach(e => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${e.date}</td><td>${capitalize(e.section)}</td><td>${e.description}</td><td>‚Ç±${e.amount.toFixed(2)}</td>`;
      tableBody.appendChild(tr);
    });
  }

  // Export expenses to PDF using jsPDF
  function exportPDF() {
    if (expenses.length === 0) {
      alert('No expenses to export');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text('Expenses Report', 14, 22);
    doc.setFontSize(12);
    doc.text(`User: ${currentUser}`, 14, 30);
    doc.text(`Income: ‚Ç±${income.toFixed(2)}`, 14, 38);

    const columns = ['Date', 'Section', 'Description', 'Amount'];
    const rows = expenses.map(e => [e.date, capitalize(e.section), e.description, `‚Ç±${e.amount.toFixed(2)}`]);

    doc.autoTable({
      head: [columns],
      body: rows,
      startY: 45,
    });

    doc.save('expenses_report.pdf');
  }

  // Utility: Capitalize first letter
  function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // Load saved user if any on page load
  window.onload = () => {
    if (currentUser) {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      loadUserData();
      showPage('expensesPage');
    }
  };
</script>

<!-- jsPDF AutoTable plugin for tables -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

</body>
</html>
