<!DOCTYPE html>     
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maki Web</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Your styles here */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f7; margin: 0; }
    .login-container, .container { max-width: 600px; margin: auto; padding: 20px; }
    .login-box, .signup-container, .section {
      background: white; padding: 30px; border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-top: 20px; position: relative;
    }
    .login-box { text-align: center; }
    .close-btn {
      position: absolute; top: 10px; right: 15px; cursor: pointer;
      background: none; border: none; font-size: 20px;
    }
    input[type="text"], input[type="password"], input[type="number"], input[type="date"] {
      width: 100%; padding: 10px; margin: 10px 0;
      border-radius: 10px; border: 1px solid #ccc;
    }
    button {
      padding: 10px 15px; border: none; background: #555; color: white;
      border-radius: 10px; cursor: pointer;
    }
    button:hover { background: #333; }
    .nav-buttons {
      display: flex; flex-wrap: wrap; gap: 10px;
      justify-content: center; margin-bottom: 20px;
    }
    .nav-buttons button { flex: 1; min-width: 100px; }
    .dashboard, .page { display: none; }
    .active { display: block; }
    .item {
      display: flex; align-items: center; gap: 10px; margin: 10px 0;
    }
    .item input[type="number"], .item input[type="date"] { width: 100px; display: block; }
    .item button {
      background-color: red; border-radius: 50%; padding: 5px 10px;
      border: none; color: white; font-weight: bold; cursor: pointer;
    }
    footer {
      text-align: center; padding: 10px; background: #ddd;
      position: fixed; bottom: 0; width: 100%;
    }
    table {
      border-collapse: collapse; 
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px; text-align: left;
    }

    /* Archive view styles */
    #archiveContainer {
      display: none;
      background: white; padding: 20px; border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }
    #archiveContainer h3 {
      margin-top: 0;
    }
    #archiveList {
      list-style: none;
      padding-left: 0;
    }
    #archiveList li {
      padding: 8px; border-bottom: 1px solid #ccc; cursor: pointer;
    }
    #archiveList li:hover {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

<div class="login-container" id="loginPage" style="display: block;">
  <div class="login-box">
    <h1>Budget Tracker</h1>
    <input type="text" id="loginUsername" placeholder="Username" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button onclick="login()">Log In</button>
    <p id="loginError" style="color:red;"></p>
    <hr />
    <button onclick="document.getElementById('signupContainer').style.display = 'block';">Create Account</button>
  </div>
  <div id="signupContainer" class="signup-container" style="display:none;">
    <button class="close-btn" onclick="document.getElementById('signupContainer').style.display='none';">‚úñ</button>
    <h3>Sign Up</h3>
    <input type="text" id="newUsername" placeholder="New Username" />
    <input type="password" id="newPassword" placeholder="New Password" />
    <button onclick="addUser()">Sign Up</button>
  </div>
</div>

<div class="container dashboard" id="dashboard" style="display: none;">
  <div class="nav-buttons">
    <button onclick="showPage('settingsPage')">‚öôÔ∏è Settings</button>
    <button onclick="showPage('expensesPage')">üìÑ Expenses</button>
    <button onclick="showPage('groceryPage')">üõí Grocery</button>
    <button onclick="showPage('onlinePage')">üíª Online</button>
    <button onclick="showPage('marketPage')">üß∫ Market</button>
    <button onclick="toggleArchive()">üóÉÔ∏è Archive</button>
    <button onclick="logout()">üö™ Logout</button>
  </div>

  <div id="settingsPage" class="page section">
    <h2>Settings</h2>
    <input type="text" id="removeUsername" placeholder="Username to Remove" />
    <button onclick="removeUser()">Remove User</button>
  </div>

  <div id="expensesPage" class="page section">
    <h2>Expenses Report</h2>
    <input type="number" id="incomeInput" placeholder="Set Income" />
    <button onclick="setIncome()">Update Income</button>
    <p>Income: ‚Ç±<span id="incomeDisplay">0.00</span></p>
    <p>Expenses: ‚Ç±<span id="expensesDisplay">0.00</span></p>
    <p>Balance: ‚Ç±<span id="expensesBalance">0.00</span></p>
    <label>Filter by Date:</label>
    <input type="date" id="filterDate" onchange="loadExpenses()" />
    <button onclick="exportPDF()">üìÑ Export as PDF</button>
    <table style="width:100%; margin-top:10px;">
      <thead><tr><th>Date</th><th>Section</th><th>Description</th><th>Amount</th></tr></thead>
      <tbody id="expensesTable"></tbody>
    </table>
  </div>

  <!-- Grocery Page -->
  <div id="groceryPage" class="page section">
    <h2>Grocery Budget</h2>
    <input type="number" id="groceryBudgetInput" placeholder="Set Budget" />
    <button onclick="setBudget('grocery')">Set Budget</button>
    <p>Budget: ‚Ç±<span id="groceryBudget">0.00</span></p>
    <p>Balance: ‚Ç±<span id="groceryBalance">0.00</span></p>
    <input type="text" id="groceryNewItemName" placeholder="New Item Name" />
    <button onclick="addNewItem('grocery')">Add Item</button>
    <div id="groceryItemsList"></div>
  </div>

  <!-- Online Page -->
  <div id="onlinePage" class="page section">
    <h2>Online Budget</h2>
    <input type="number" id="onlineBudgetInput" placeholder="Set Budget" />
    <button onclick="setBudget('online')">Set Budget</button>
    <p>Budget: ‚Ç±<span id="onlineBudget">0.00</span></p>
    <p>Balance: ‚Ç±<span id="onlineBalance">0.00</span></p>
    <input type="text" id="onlineNewItemName" placeholder="New Item Name" />
    <button onclick="addNewItem('online')">Add Item</button>
    <div id="onlineItemsList"></div>
  </div>

  <!-- Market Page -->
  <div id="marketPage" class="page section">
    <h2>Market Budget</h2>
    <input type="number" id="marketBudgetInput" placeholder="Set Budget" />
    <button onclick="setBudget('market')">Set Budget</button>
    <p>Budget: ‚Ç±<span id="marketBudget">0.00</span></p>
    <p>Balance: ‚Ç±<span id="marketBalance">0.00</span></p>
    <input type="text" id="marketNewItemName" placeholder="New Item Name" />
    <button onclick="addNewItem('market')">Add Item</button>
    <div id="marketItemsList"></div>
  </div>

  <!-- Archive Container -->
  <div id="archiveContainer" class="section">
    <h3>Archived Budgets</h3>
    <ul id="archiveList"></ul>
    <button onclick="closeArchive()">Close Archive</button>
    <div id="archiveDetails"></div>
  </div>
</div>

<footer>
  <p>¬© 2025 Maki Web Budget Tracker</p>
</footer>

<script>
  // Users DB simulation
  let users = JSON.parse(localStorage.getItem('users')) || [
    { username: 'user', password: 'pass' }
  ];

  let currentUser = null;

  // Load users from localStorage
  function saveUsers() {
    localStorage.setItem('users', JSON.stringify(users));
  }

  function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    const user = users.find(u => u.username === username && u.password === password);
    if (user) {
      currentUser = username;
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      showPage('expensesPage');
      loadIncome();
      loadExpenses();
      loadBudgets();
      loadAllItems();
      clearLoginInputs();
    } else {
      document.getElementById('loginError').textContent = 'Invalid username or password';
    }
  }

  function logout() {
    currentUser = null;
    document.getElementById('dashboard').style.display = 'none';
    document.getElementById('loginPage').style.display = 'block';
  }

  function addUser() {
    const username = document.getElementById('newUsername').value.trim();
    const password = document.getElementById('newPassword').value.trim();
    if (!username || !password) {
      alert('Please enter a username and password.');
      return;
    }
    if (users.find(u => u.username === username)) {
      alert('Username already exists.');
      return;
    }
    users.push({ username, password });
    saveUsers();
    alert('User created! You can now log in.');
    document.getElementById('signupContainer').style.display = 'none';
  }

  function removeUser() {
    const username = document.getElementById('removeUsername').value.trim();
    if (!username) {
      alert('Enter username to remove.');
      return;
    }
    if (username === currentUser) {
      alert('You cannot remove your own account while logged in.');
      return;
    }
    users = users.filter(u => u.username !== username);
    saveUsers();
    alert('User removed if existed.');
  }

  function clearLoginInputs() {
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').textContent = '';
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
  }

  // Page navigation
  function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
    document.getElementById('archiveContainer').style.display = 'none'; // hide archive if open
    document.getElementById(pageId).style.display = 'block';
  }

  // Storage keys helpers
  function getUserKey(key) {
    return `${currentUser}_${key}`;
  }

  // Income & Expenses Handling
  function setIncome() {
    const incomeInput = document.getElementById('incomeInput');
    let income = parseFloat(incomeInput.value);
    if (isNaN(income) || income < 0) {
      alert('Please enter a valid positive income.');
      return;
    }
    localStorage.setItem(getUserKey('income'), income.toFixed(2));

    // Archive old budgets and expenses before reset
    archiveCurrentData();

    // Reset all budgets, expenses, and items on new income set
    resetAllBudgetsAndExpenses();

    loadIncome();
    loadBudgets();
    loadExpenses();
    loadAllItems();
    alert('Income updated and all budgets/expenses reset.');
  }

  function loadIncome() {
    let income = parseFloat(localStorage.getItem(getUserKey('income'))) || 0;
    document.getElementById('incomeDisplay').textContent = income.toFixed(2);
    document.getElementById('incomeInput').value = income > 0 ? income : '';
  }

  // Reset all budgets, items, and expenses
  function resetAllBudgetsAndExpenses() {
    ['grocery', 'online', 'market'].forEach(section => {
      localStorage.removeItem(getUserKey(`${section}_budget`));
      localStorage.removeItem(getUserKey(`${section}_items`));
    });
    localStorage.removeItem(getUserKey('expenses'));
  }

  // Archive current data before reset on new income set
  function archiveCurrentData() {
    const income = localStorage.getItem(getUserKey('income'));
    const expenses = localStorage.getItem(getUserKey('expenses'));
    const groceryBudget = localStorage.getItem(getUserKey('grocery_budget'));
    const groceryItems = localStorage.getItem(getUserKey('grocery_items'));
    const onlineBudget = localStorage.getItem(getUserKey('online_budget'));
    const onlineItems = localStorage.getItem(getUserKey('online_items'));
    const marketBudget = localStorage.getItem(getUserKey('market_budget'));
    const marketItems = localStorage.getItem(getUserKey('market_items'));

    // Get current timestamp for archive key
    const archiveTimestamp = new Date().toISOString();

    // Prepare archive object
    const archiveEntry = {
      timestamp: archiveTimestamp,
      income: income || "0",
      expenses: expenses || "[]",
      grocery_budget: groceryBudget || "0",
      grocery_items: groceryItems || "[]",
      online_budget: onlineBudget || "0",
      online_items: onlineItems || "[]",
      market_budget: marketBudget || "0",
      market_items: marketItems || "[]",
    };

    // Load existing archives
    let archives = JSON.parse(localStorage.getItem(getUserKey('archives')) || "[]");
    archives.push(archiveEntry);
    localStorage.setItem(getUserKey('archives'), JSON.stringify(archives));
  }

  // Load expenses filtered by date or all
  function loadExpenses() {
    let expenses = JSON.parse(localStorage.getItem(getUserKey('expenses')) || "[]");
    const filterDate = document.getElementById('filterDate').value;
    if (filterDate) {
      expenses = expenses.filter(e => e.date === filterDate);
    }
    const expensesTable = document.getElementById('expensesTable');
    expensesTable.innerHTML = '';
    let totalExpenses = 0;

    expenses.forEach(exp => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${exp.date}</td>
        <td>${exp.section}</td>
        <td>${exp.name}</td>
        <td>‚Ç±${parseFloat(exp.amount).toFixed(2)}</td>
      `;
      expensesTable.appendChild(row);
      totalExpenses += parseFloat(exp.amount);
    });

    const income = parseFloat(localStorage.getItem(getUserKey('income'))) || 0;
    const balance = income - totalExpenses;

    document.getElementById('expensesDisplay').textContent = totalExpenses.toFixed(2);
    document.getElementById('expensesBalance').textContent = balance.toFixed(2);
  }

  // Export expenses as PDF
  async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let expenses = JSON.parse(localStorage.getItem(getUserKey('expenses')) || "[]");
    const filterDate = document.getElementById('filterDate').value;
    if (filterDate) {
      expenses = expenses.filter(e => e.date === filterDate);
    }

    doc.text("Expenses Report", 14, 16);

    const tableColumn = ["Date", "Section", "Description", "Amount"];
    const tableRows = [];

    expenses.forEach(exp => {
      const expenseData = [
        exp.date,
        exp.section,
        exp.name,
        `‚Ç±${parseFloat(exp.amount).toFixed(2)}`
      ];
      tableRows.push(expenseData);
    });

    doc.autoTable({
      head: [tableColumn],
      body: tableRows,
      startY: 20,
    });

    const income = parseFloat(localStorage.getItem(getUserKey('income'))) || 0;
    const totalExpenses = expenses.reduce((a, e) => a + parseFloat(e.amount), 0);
    const balance = income - totalExpenses;

    doc.text(`Income: ‚Ç±${income.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 10);
    doc.text(`Total Expenses: ‚Ç±${totalExpenses.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 16);
    doc.text(`Balance: ‚Ç±${balance.toFixed(2)}`, 14, doc.lastAutoTable.finalY + 22);

    doc.save("expenses_report.pdf");
  }

  // Budgets & Items Management
  function setBudget(section) {
    const input = document.getElementById(`${section}BudgetInput`);
    let budgetValue = parseFloat(input.value);
    if (isNaN(budgetValue) || budgetValue < 0) {
      alert('Enter a valid budget amount.');
      return;
    }
    const income = parseFloat(localStorage.getItem(getUserKey('income'))) || 0;

    if (budgetValue > income) {
      alert('Budget cannot exceed total income.');
      return;
    }

    localStorage.setItem(getUserKey(`${section}_budget`), budgetValue.toFixed(2));
    input.value = budgetValue.toFixed(2);

    // Reset section items and expenses if you want:
    localStorage.removeItem(getUserKey(`${section}_items`));
    loadBudgetDisplay(section);
    loadItems(section);
  }

  function loadBudgets() {
    ['grocery', 'online', 'market'].forEach(section => loadBudgetDisplay(section));
  }

  function loadBudgetDisplay(section) {
    const budget = parseFloat(localStorage.getItem(getUserKey(`${section}_budget`))) || 0;
    document.getElementById(`${section}Budget`).textContent = budget.toFixed(2);
    const expenses = getTotalExpensesBySection(section);
    document.getElementById(`${section}Balance`).textContent = (budget - expenses).toFixed(2);
  }

  function getTotalExpensesBySection(section) {
    const expenses = JSON.parse(localStorage.getItem(getUserKey('expenses')) || "[]");
    return expenses
      .filter(e => e.section === section)
      .reduce((sum, e) => sum + parseFloat(e.amount), 0);
  }

  // Items Management
  function addNewItem(section) {
    const input = document.getElementById(`${section}NewItemName`);
    const itemName = input.value.trim();
    if (!itemName) {
      alert('Enter item name.');
      return;
    }

    let items = JSON.parse(localStorage.getItem(getUserKey(`${section}_items`)) || "[]");
    if (items.find(i => i.name.toLowerCase() === itemName.toLowerCase())) {
      alert('Item already exists.');
      return;
    }

    items.push({ name: itemName, amount: 0 });
    localStorage.setItem(getUserKey(`${section}_items`), JSON.stringify(items));
    input.value = '';
    loadItems(section);
  }

  function loadItems(section) {
    const container = document.getElementById(`${section}ItemsList`);
    container.innerHTML = '';
    let items = JSON.parse(localStorage.getItem(getUserKey(`${section}_items`)) || "[]");
    const budget = parseFloat(localStorage.getItem(getUserKey(`${section}_budget`))) || 0;

    items.forEach((item, index) => {
      const div = document.createElement('div');
      div.classList.add('item');
      div.innerHTML = `
        <input type="text" readonly value="${item.name}" />
        <input type="number" min="0" step="0.01" value="${item.amount}" onchange="updateItemAmount('${section}', ${index}, this.value)" />
        <button onclick="deleteItem('${section}', ${index})">x</button>
      `;
      container.appendChild(div);
    });

    // Update balance for section
    updateSectionBalance(section);
  }

  function updateItemAmount(section, index, value) {
    let items = JSON.parse(localStorage.getItem(getUserKey(`${section}_items`)) || "[]");
    const budget = parseFloat(localStorage.getItem(getUserKey(`${section}_budget`))) || 0;

    let amount = parseFloat(value);
    if (isNaN(amount) || amount < 0) {
      alert('Invalid amount.');
      loadItems(section);
      return;
    }

    // Check total sum of item amounts <= budget
    let total = items.reduce((sum, i, idx) => sum + (idx === index ? amount : parseFloat(i.amount)), 0);
    if (total > budget) {
      alert('Total item amounts cannot exceed budget.');
      loadItems(section);
      return;
    }

    items[index].amount = amount.toFixed(2);
    localStorage.setItem(getUserKey(`${section}_items`), JSON.stringify(items));

    // Add/update expense record for this item and section
    addOrUpdateExpense(section, items[index].name, amount);

    updateSectionBalance(section);
  }

  function deleteItem(section, index) {
    let items = JSON.parse(localStorage.getItem(getUserKey(`${section}_items`)) || "[]");
    const itemName = items[index].name;
    items.splice(index, 1);
    localStorage.setItem(getUserKey(`${section}_items`), JSON.stringify(items));

    // Remove expense for this item
    removeExpenseByNameAndSection(itemName, section);

    loadItems(section);
    updateSectionBalance(section);
  }

  function addOrUpdateExpense(section, name, amount) {
    let expenses = JSON.parse(localStorage.getItem(getUserKey('expenses')) || "[]");
    const today = new Date().toISOString().slice(0, 10);

    // Check if expense with same name and section and today's date exists, update if yes
    let expenseIndex = expenses.findIndex(e => e.name === name && e.section === section && e.date === today);

    if (amount === 0) {
      // Remove if amount is 0
      if (expenseIndex >= 0) expenses.splice(expenseIndex, 1);
    } else {
      if (expenseIndex >= 0) {
        expenses[expenseIndex].amount = amount.toFixed(2);
      } else {
        expenses.push({ date: today, section, name, amount: amount.toFixed(2) });
      }
    }

    localStorage.setItem(getUserKey('expenses'), JSON.stringify(expenses));
    loadExpenses();
  }

  function removeExpenseByNameAndSection(name, section) {
    let expenses = JSON.parse(localStorage.getItem(getUserKey('expenses')) || "[]");
    expenses = expenses.filter(e => !(e.name === name && e.section === section));
    localStorage.setItem(getUserKey('expenses'), JSON.stringify(expenses));
    loadExpenses();
  }

  // Load all items for all sections
  function loadAllItems() {
    ['grocery', 'online', 'market'].forEach(section => loadItems(section));
  }

  function updateSectionBalance(section) {
    const budget = parseFloat(localStorage.getItem(getUserKey(`${section}_budget`))) || 0;
    const items = JSON.parse(localStorage.getItem(getUserKey(`${section}_items`)) || "[]");
    const totalSpent = items.reduce((sum, i) => sum + parseFloat(i.amount), 0);
    document.getElementById(`${section}Balance`).textContent = (budget - totalSpent).toFixed(2);
  }

  // Archive toggle and view
  function toggleArchive() {
    const archiveDiv = document.getElementById('archiveContainer');
    if (archiveDiv.style.display === 'block') {
      archiveDiv.style.display = 'none';
    } else {
      archiveDiv.style.display = 'block';
      showPage(''); // Hide other pages
      loadArchiveList();
    }
  }

  function closeArchive() {
    document.getElementById('archiveContainer').style.display = 'none';
    showPage('expensesPage');
  }

  function loadArchiveList() {
    const archiveList = document.getElementById('archiveList');
    archiveList.innerHTML = '';
    const archives = JSON.parse(localStorage.getItem(getUserKey('archives')) || "[]");
    if (archives.length === 0) {
      archiveList.innerHTML = '<li>No archived budgets found.</li>';
      return;
    }
    archives.forEach((archive, index) => {
      const li = document.createElement('li');
      li.textContent = new Date(archive.timestamp).toLocaleString();
      li.onclick = () => showArchiveDetails(index);
      archiveList.appendChild(li);
    });
  }

  function showArchiveDetails(index) {
    const archives = JSON.parse(localStorage.getItem(getUserKey('archives')) || "[]");
    if (index < 0 || index >= archives.length) return;
    const archive = archives[index];
    const container = document.getElementById('archiveDetails');

    // Parse expenses to readable table
    const expenses = JSON.parse(archive.expenses || '[]');
    let expensesHTML = '<table><thead><tr><th>Date</th><th>Section</th><th>Description</th><th>Amount</th></tr></thead><tbody>';
    expenses.forEach(e => {
      expensesHTML += `<tr><td>${e.date}</td><td>${e.section}</td><td>${e.name}</td><td>‚Ç±${parseFloat(e.amount).toFixed(2)}</td></tr>`;
    });
    expensesHTML += '</tbody></table>';

    container.innerHTML = `
      <h4>Archived on: ${new Date(archive.timestamp).toLocaleString()}</h4>
      <p><strong>Income:</strong> ‚Ç±${parseFloat(archive.income).toFixed(2)}</p>
      <h5>Expenses:</h5>
      ${expensesHTML}
      <h5>Budgets:</h5>
      <ul>
        <li>Grocery: ‚Ç±${parseFloat(archive.grocery_budget).toFixed(2)}</li>
        <li>Online: ‚Ç±${parseFloat(archive.online_budget).toFixed(2)}</li>
        <li>Market: ‚Ç±${parseFloat(archive.market_budget).toFixed(2)}</li>
      </ul>
      <h5>Items:</h5>
      <ul>
        <li>Grocery Items: ${JSON.parse(archive.grocery_items || '[]').map(i => i.name).join(', ') || 'None'}</li>
        <li>Online Items: ${JSON.parse(archive.online_items || '[]').map(i => i.name).join(', ') || 'None'}</li>
        <li>Market Items: ${JSON.parse(archive.market_items || '[]').map(i => i.name).join(', ') || 'None'}</li>
      </ul>
    `;
  }

</script>

</body>
</html>
