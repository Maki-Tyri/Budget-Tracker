<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Budget Tracker</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background-color: #ccc; margin: 0; padding: 0; }
    .login-container, .dashboard, .section { max-width: 500px; margin: 50px auto; padding: 20px; background: #eee; border-radius: 10px; display: none; }
    .login-container.active, .dashboard.active, .section.active { display: block; }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; margin-bottom: 5px; }
    .input-group input { width: 100%; padding: 10px; }
    .button { padding: 10px 20px; background: #888; color: white; border: none; cursor: pointer; margin-top: 10px; }
    .button:hover { background: #555; }
    .icon-container { display: flex; justify-content: space-around; margin-top: 20px; }
    .icon { text-align: center; cursor: pointer; user-select: none; }
    .icon:hover { font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #999; padding: 8px; text-align: left; }
    .hidden { display: none; }
    #groceryItems > div, #onlineItems > div { margin-bottom: 8px; }
    #groceryItems input[type="text"], #onlineItems input[type="text"] {
      width: 60%;
      padding: 5px;
      margin-right: 10px;
    }
    #groceryItems input[type="number"], #onlineItems input[type="number"] {
      width: 25%;
      padding: 5px;
    }
  </style>
</head>
<body>
  <div class="login-container active" id="loginPage">
    <h2>Login</h2>
    <div class="input-group">
      <label>Username</label>
      <input type="text" id="username" />
    </div>
    <div class="input-group">
      <label>Password</label>
      <input type="password" id="password" />
    </div>
    <button class="button" onclick="login()">Log In</button>
  </div>

  <div class="dashboard" id="dashboard">
    <h2>Welcome, <span id="displayUser"></span>!</h2>
    <div class="icon-container">
      <div class="icon" onclick="showSection('settings')">‚öôÔ∏è<br />Settings</div>
      <div class="icon" onclick="showSection('report')">üìÑ<br />Expenses Report</div>
      <div class="icon" onclick="showSection('grocery')">üõí<br />Grocery</div>
      <div class="icon" onclick="showSection('online')">üíª<br />Online</div>
      <div class="icon" onclick="logout()">üö™<br />Logout</div>
    </div>
  </div>

  <div class="section" id="settings">
    <h3>Settings</h3>
    <div class="input-group">
      <label>New Username</label>
      <input type="text" id="newUsername" />
    </div>
    <div class="input-group">
      <label>New Password</label>
      <input type="password" id="newPassword" />
    </div>
    <button class="button" onclick="updateCredentials()">Update</button>
  </div>

  <div class="section" id="report">
    <h3>Expenses Report</h3>
    <div class="input-group">
      <label>Income</label>
      <input type="number" id="incomeInput" placeholder="‚Ç±" />
    </div>
    <div class="input-group">
      <label>Expenses</label>
      <input type="number" id="expensesInput" placeholder="‚Ç±" />
    </div>
    <button class="button" onclick="updateReport()">Add to Report</button>
    <button class="button" onclick="savePDF('report')">Save as PDF</button>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Income</th>
          <th>Expenses</th>
          <th>Balance</th>
        </tr>
      </thead>
      <tbody id="reportTable"></tbody>
    </table>
  </div>

  <div class="section" id="grocery">
    <h3>Grocery</h3>
    <div class="input-group">
      <label>Set Grocery Budget</label>
      <input type="number" id="groceryBudgetInput" placeholder="‚Ç±" />
      <button class="button" onclick="setGroceryBudget()">Set</button>
    </div>
    <button class="button" onclick="savePDF('grocery')">Save as PDF</button>
    <div>Budget: ‚Ç±<span id="groceryBudget">0</span> | Balance: ‚Ç±<span id="groceryBalance">0</span></div>
    <div id="groceryItems"></div>
    <button class="button" onclick="addGroceryItem()">Add Item</button>
  </div>

  <div class="section" id="online">
    <h3>Online</h3>
    <div class="input-group">
      <label>Set Online Budget</label>
      <input type="number" id="onlineBudgetInput" placeholder="‚Ç±" />
      <button class="button" onclick="setOnlineBudget()">Set</button>
    </div>
    <button class="button" onclick="savePDF('online')">Save as PDF</button>
    <div>Budget: ‚Ç±<span id="onlineBudget">0</span> | Balance: ‚Ç±<span id="onlineBalance">0</span></div>
    <div id="onlineItems"></div>
    <button class="button" onclick="addOnlineItem()">Add Item</button>
  </div>

  <!-- Include jsPDF from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    let currentUser = '';

    async function savePDF(sectionId) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      if (!currentUser) {
        alert('Please login first!');
        return;
      }

      let y = 10;
      doc.setFontSize(16);
      doc.text(`Budget Tracker - ${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`, 10, y);
      y += 10;

      if (sectionId === 'report') {
        const report = JSON.parse(localStorage.getItem(currentUser + '_report')) || [];
        if(report.length === 0) {
          alert('No report data to save.');
          return;
        }
        doc.setFontSize(12);
        // Table headers
        doc.text('Date', 10, y);
        doc.text('Income', 70, y);
        doc.text('Expenses', 110, y);
        doc.text('Balance', 150, y);
        y += 6;
        doc.setLineWidth(0.5);
        doc.line(10, y, 190, y);
        y += 4;
        // Table content
        report.forEach(row => {
          if(y > 270){ doc.addPage(); y=10; } // Add page if too long
          doc.text(row.date, 10, y);
          doc.text('‚Ç±' + row.income.toFixed(2), 70, y);
          doc.text('‚Ç±' + row.expenses.toFixed(2), 110, y);
          doc.text('‚Ç±' + row.balance.toFixed(2), 150, y);
          y += 8;
        });
      }
      else if(sectionId === 'grocery' || sectionId === 'online') {
        const budget = parseFloat(localStorage.getItem(currentUser + `_${sectionId}Budget`)) || 0;
        const items = JSON.parse(localStorage.getItem(currentUser + `_${sectionId}Items`)) || [];

        doc.setFontSize(12);
        doc.text(`Budget: ‚Ç±${budget.toFixed(2)}`, 10, y);
        y += 8;

        if(items.length === 0){
          doc.text('No items added.', 10, y);
        } else {
          // Headers
          doc.text('Item Name', 10, y);
          doc.text('Checked', 90, y);
          doc.text('Price', 140, y);
          y += 6;
          doc.setLineWidth(0.5);
          doc.line(10, y, 190, y);
          y += 4;

          items.forEach(item => {
            if(y > 270){ doc.addPage(); y=10; }
            doc.text(item.name, 10, y);
            doc.text(item.checked ? 'Yes' : 'No', 90, y);
            doc.text(item.checked ? `‚Ç±${parseFloat(item.price).toFixed(2)}` : '‚Ç±0.00', 140, y);
            y += 8;
          });

          // Calculate balance
          const totalSpent = items.reduce((sum, i) => sum + (i.checked ? parseFloat(i.price) || 0 : 0), 0);
          const balance = budget - totalSpent;
          y += 6;
          doc.text(`Balance: ‚Ç±${balance.toFixed(2)}`, 10, y);
        }
      }
      else {
        alert('PDF export not supported for this section.');
        return;
      }

      // Save PDF
  doc.save(`${currentUser}_${sectionId}_budget_report.pdf`);
}

// Simple login with localStorage
function login() {
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();

  if (!u || !p) {
    alert('Enter username and password.');
    return;
  }

  // For demo: user stored as username:password in localStorage
  const storedPass = localStorage.getItem('user_' + u);
  if (storedPass === p) {
    currentUser = u;
    document.getElementById('displayUser').textContent = u;
    document.getElementById('loginPage').classList.remove('active');
    document.getElementById('dashboard').classList.add('active');
    hideAllSections();
    loadReportTable();
    loadGrocery();
    loadOnline();
  } else {
    alert('Invalid credentials or user not found.');
  }
}

function logout() {
  currentUser = '';
  document.getElementById('loginPage').classList.add('active');
  document.getElementById('dashboard').classList.remove('active');
  hideAllSections();
  clearInputs();
}

function hideAllSections() {
  ['settings','report','grocery','online'].forEach(id => {
    document.getElementById(id).classList.remove('active');
  });
}

function showSection(id) {
  if(!currentUser){
    alert('Please login first.');
    return;
  }
  hideAllSections();
  document.getElementById(id).classList.add('active');
}

function updateCredentials() {
  const newU = document.getElementById('newUsername').value.trim();
  const newP = document.getElementById('newPassword').value.trim();
  if (!newU || !newP) {
    alert('Enter new username and password.');
    return;
  }
  // Check if new username exists
  if (localStorage.getItem('user_' + newU) && newU !== currentUser) {
    alert('Username already exists.');
    return;
  }
  // Migrate data to new username if changing username
  if(newU !== currentUser) {
    // Migrate all user data keys
    for(let key in localStorage){
      if(key.startsWith(currentUser + '_')){
        const newKey = key.replace(currentUser + '_', newU + '_');
        localStorage.setItem(newKey, localStorage.getItem(key));
        localStorage.removeItem(key);
      }
    }
    // Remove old user password
    localStorage.removeItem('user_' + currentUser);
    currentUser = newU;
  }
  // Update password
  localStorage.setItem('user_' + currentUser, newP);
  alert('Credentials updated.');
  document.getElementById('displayUser').textContent = currentUser;
  clearInputs();
}

function clearInputs() {
  document.getElementById('username').value = '';
  document.getElementById('password').value = '';
  document.getElementById('newUsername').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('incomeInput').value = '';
  document.getElementById('expensesInput').value = '';
  document.getElementById('groceryBudgetInput').value = '';
  document.getElementById('onlineBudgetInput').value = '';
}

// REPORT section
function updateReport() {
  const income = parseFloat(document.getElementById('incomeInput').value) || 0;
  const expenses = parseFloat(document.getElementById('expensesInput').value) || 0;
  if (income === 0 && expenses === 0) {
    alert('Enter income or expenses.');
    return;
  }

  const report = JSON.parse(localStorage.getItem(currentUser + '_report')) || [];
  const lastBalance = report.length ? report[report.length -1].balance : 0;
  const newBalance = lastBalance + income - expenses;
  const date = new Date().toLocaleString();

  report.push({ date, income, expenses, balance: newBalance });
  localStorage.setItem(currentUser + '_report', JSON.stringify(report));
  loadReportTable();
  document.getElementById('incomeInput').value = '';
  document.getElementById('expensesInput').value = '';
}

function loadReportTable() {
  const report = JSON.parse(localStorage.getItem(currentUser + '_report')) || [];
  const tbody = document.getElementById('reportTable');
  tbody.innerHTML = '';
  report.forEach(row => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${row.date}</td><td>‚Ç±${row.income.toFixed(2)}</td><td>‚Ç±${row.expenses.toFixed(2)}</td><td>‚Ç±${row.balance.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
}

// Grocery section
function setGroceryBudget() {
  const budget = parseFloat(document.getElementById('groceryBudgetInput').value);
  if (isNaN(budget) || budget < 0) {
    alert('Invalid budget.');
    return;
  }
  localStorage.setItem(currentUser + '_groceryBudget', budget);
  loadGrocery();
  document.getElementById('groceryBudgetInput').value = '';
}

function addGroceryItem() {
  const items = JSON.parse(localStorage.getItem(currentUser + '_groceryItems')) || [];
  items.push({name: '', checked: false, price: 0});
  localStorage.setItem(currentUser + '_groceryItems', JSON.stringify(items));
  loadGrocery();
}

function loadGrocery() {
  const budget = parseFloat(localStorage.getItem(currentUser + '_groceryBudget')) || 0;
  const items = JSON.parse(localStorage.getItem(currentUser + '_groceryItems')) || [];
  document.getElementById('groceryBudget').textContent = budget.toFixed(2);

  const container = document.getElementById('groceryItems');
  container.innerHTML = '';
  let totalSpent = 0;
  items.forEach((item, i) => {
    const div = document.createElement('div');
    div.innerHTML = `
      <input type="checkbox" id="groceryChk${i}" ${item.checked ? 'checked' : ''} />
      <input type="text" id="groceryName${i}" value="${item.name}" placeholder="Item name" />
      <input type="number" id="groceryPrice${i}" value="${item.price}" step="0.01" placeholder="‚Ç±" ${item.checked ? '' : 'disabled'} />
      <button onclick="removeGroceryItem(${i})">‚ùå</button>
    `;
    container.appendChild(div);

    // Add event listeners
    div.querySelector(`#groceryChk${i}`).addEventListener('change', e => {
      items[i].checked = e.target.checked;
      if (e.target.checked) {
        div.querySelector(`#groceryPrice${i}`).disabled = false;
        if (!items[i].price) items[i].price = 0;
      } else {
        div.querySelector(`#groceryPrice${i}`).disabled = true;
        items[i].price = 0;
      }
      saveGroceryItems(items);
      loadGrocery();
    });
    div.querySelector(`#groceryName${i}`).addEventListener('input', e => {
      items[i].name = e.target.value;
      saveGroceryItems(items);
    });
    div.querySelector(`#groceryPrice${i}`).addEventListener('input', e => {
      const val = parseFloat(e.target.value);
      items[i].price = isNaN(val) ? 0 : val;
      saveGroceryItems(items);
      loadGrocery();
    });

    if (item.checked) totalSpent += parseFloat(item.price) || 0;
  });

  const balance = budget - totalSpent;
  document.getElementById('groceryBalance').textContent = balance.toFixed(2);
}

function saveGroceryItems(items) {
  localStorage.setItem(currentUser + '_groceryItems', JSON.stringify(items));
}

function removeGroceryItem(index) {
  const items = JSON.parse(localStorage.getItem(currentUser + '_groceryItems')) || [];
  items.splice(index, 1);
  saveGroceryItems(items);
  loadGrocery();
}

// Online section (similar to Grocery)
function setOnlineBudget() {
  const budget = parseFloat(document.getElementById('onlineBudgetInput').value);
  if (isNaN(budget) || budget < 0) {
    alert('Invalid budget.');
    return;
  }
  localStorage.setItem(currentUser + '_onlineBudget', budget);
  loadOnline();
  document.getElementById('onlineBudgetInput').value = '';
}

function addOnlineItem() {
  const items = JSON.parse(localStorage.getItem(currentUser + '_onlineItems')) || [];
  items.push({name: '', checked: false, price: 0});
  localStorage.setItem(currentUser + '_onlineItems', JSON.stringify(items));
  loadOnline();
}

function loadOnline() {
  const budget = parseFloat(localStorage.getItem(currentUser + '_onlineBudget')) || 0;
  const items = JSON.parse(localStorage.getItem(currentUser + '_onlineItems')) || [];
  document.getElementById('onlineBudget').textContent = budget.toFixed(2);

  const container = document.getElementById('onlineItems');
  container.innerHTML = '';
  let totalSpent = 0;
  items.forEach((item, i) => {
    const div = document.createElement('div');
    div.innerHTML = `
      <input type="checkbox" id="onlineChk${i}" ${item.checked ? 'checked' : ''} />
      <input type="text" id="onlineName${i}" value="${item.name}" placeholder="Item name" />
      <input type="number" id="onlinePrice${i}" value="${item.price}" step="0.01" placeholder="‚Ç±" ${item.checked ? '' : 'disabled'} />
      <button onclick="removeOnlineItem(${i})">‚ùå</button>
    `;
    container.appendChild(div);

    // Add event listeners
    div.querySelector(`#onlineChk${i}`).addEventListener('change', e => {
      items[i].checked = e.target.checked;
      if (e.target.checked) {
        div.querySelector(`#onlinePrice${i}`).disabled = false;
        if (!items[i].price) items[i].price = 0;
      } else {
        div.querySelector(`#onlinePrice${i}`).disabled = true;
        items[i].price = 0;
      }
      saveOnlineItems(items);
      loadOnline();
    });
    div.querySelector(`#onlineName${i}`).addEventListener('input', e => {
      items[i].name = e.target.value;
      saveOnlineItems(items);
    });
    div.querySelector(`#onlinePrice${i}`).addEventListener('input', e => {
      const val = parseFloat(e.target.value);
      items[i].price = isNaN(val) ? 0 : val;
      saveOnlineItems(items);
      loadOnline();
    });

    if (item.checked) totalSpent += parseFloat(item.price) || 0;
  });

  const balance = budget - totalSpent;
  document.getElementById('onlineBalance').textContent = balance.toFixed(2);
}

function saveOnlineItems(items) {
  localStorage.setItem(currentUser + '_onlineItems', JSON.stringify(items));
}

function removeOnlineItem(index) {
  const items = JSON.parse(localStorage.getItem(currentUser + '_onlineItems')) || [];
  items.splice(index, 1);
  saveOnlineItems(items);
  loadOnline();
}

// On page load, for demo, create a default user if none exists
window.onload = () => {
  if(!localStorage.getItem('user_Tapado')){
    localStorage.setItem('user_Tapado', '0000');
  }
}
</script> </body> </html>
